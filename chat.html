<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Modern Real-Time Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" />
  <!-- Fallback if CDN fails -->
  <style>
    /* Fallback icons using Unicode if Font Awesome fails to load */
    .fa-sign-out-alt::before { content: "üö™"; }
    .fa-phone::before { content: "üìû"; }
    .fa-paper-plane::before { content: "‚úàÔ∏è"; }
    .fa-history::before { content: "üìú"; }
    .fa-users::before { content: "üë•"; }
    .fa-plus::before { content: "‚ûï"; }
    .fa-times::before { content: "‚úñÔ∏è"; }
    .fa-exclamation-triangle::before { content: "‚ö†Ô∏è"; }
    .fa-moon::before { content: "üåô"; }
    .fa-sun::before { content: "‚òÄÔ∏è"; }
    .fa-microphone::before { content: "üé§"; }
    .fa-microphone-slash::before { content: "üîá"; }
    .fa-phone-slash::before { content: "üìµ"; }
  </style>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
      --secondary-gradient: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%);
      --accent-color: #8b5cf6;
      --accent-hover: #7c3aed;
      --success-color: #22c55e;
      --danger-color: #ef4444;
      --warning-color: #f59e0b;
      --bg-primary: rgba(255, 255, 255, 0.08);
      --bg-secondary: rgba(255, 255, 255, 0.12);
      --bg-tertiary: rgba(255, 255, 255, 0.18);
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.85);
      --text-muted: rgba(255, 255, 255, 0.65);
      --shadow-sm: 0 2px 8px rgba(99, 102, 241, 0.2);
      --shadow-md: 0 4px 16px rgba(99, 102, 241, 0.25);
      --shadow-lg: 0 8px 32px rgba(99, 102, 241, 0.3);
      --shadow-xl: 0 16px 64px rgba(99, 102, 241, 0.4);
      --border-radius: 16px;
      --border-radius-sm: 8px;
      --border-radius-lg: 24px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
      background-attachment: fixed;
      color: var(--text-primary);
      overflow-x: hidden;
      min-height: 100vh;
      transition: var(--transition);
    }

    body.dark-mode {
      background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #1e293b 100%);
    }

    /* Top Navigation Bar */
    #top-bar {
      width: 100%;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 32px;
      box-shadow: var(--shadow-md);
      position: sticky;
      top: 0;
      z-index: 1000;
      transition: var(--transition);
    }

    #top-bar .brand {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 12px;
      letter-spacing: -0.5px;
    }

    #top-bar .brand::before {
      content: 'üí¨';
      font-size: 1.8rem;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    #top-bar .controls {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    #top-bar .welcome {
      font-size: 0.95rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    #top-bar .welcome #username-display {
      color: var(--text-primary);
      font-weight: 600;
    }

    #logoutButton {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: #fff;
      border: none;
      border-radius: var(--border-radius-sm);
      padding: 10px 20px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    #logoutButton:hover {
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-color) 100%);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    #logoutButton i {
      font-size: 0.9rem;
    }

    #logoutButton:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    #logoutButton:active {
      transform: translateY(0);
    }

    /* Main Chat Container */
    #chat-container {
      display: flex;
      max-width: 1400px;
      margin: 24px auto;
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: var(--border-radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--border-color);
      height: calc(100vh - 120px);
      transition: var(--transition);
    }

    /* Sidebar - Conversations */
    #conversations {
      width: 380px;
      background: var(--bg-secondary);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      padding: 24px;
      overflow: hidden;
    }

    #conversations h3 {
      color: var(--text-primary);
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #conversations h3::before {
      content: 'üìã';
      font-size: 1.3rem;
    }

    #conversations input {
      width: 100%;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-sm);
      padding: 12px 16px;
      color: var(--text-primary);
      font-size: 0.95rem;
      margin-bottom: 20px;
      transition: var(--transition);
    }

    #conversations input:focus {
      outline: none;
      border-color: var(--accent-color);
      background: rgba(59, 130, 246, 0.1);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    #conversations input::placeholder {
      color: var(--text-muted);
    }

    #conversations-list {
      list-style: none;
      overflow-y: auto;
      flex: 1;
      padding-right: 8px;
    }

    #conversations-list::-webkit-scrollbar {
      width: 6px;
    }

    #conversations-list::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    #conversations-list::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
    }

    #conversations-list::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    #conversations-list li {
      padding: 16px;
      border-radius: var(--border-radius-sm);
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: var(--transition);
      margin-bottom: 8px;
      background: var(--bg-tertiary);
      border: 1px solid transparent;
    }

    #conversations-list li:hover {
      background: rgba(37, 99, 235, 0.2);
      border-color: var(--border-color);
      transform: translateX(4px);
    }

    #conversations-list li.active {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.3) 0%, rgba(30, 64, 175, 0.3) 100%);
      border-color: var(--accent-color);
      box-shadow: var(--shadow-sm);
    }

    .conversation-item.unread::before {
      content: '‚óè';
      color: var(--success-color);
      margin-right: 8px;
      font-size: 1.2rem;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.2); }
    }

    #conversations-list .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 1.1rem;
      font-weight: 600;
      flex-shrink: 0;
      box-shadow: var(--shadow-sm);
      border: 2px solid rgba(59, 130, 246, 0.4);
    }

    #noUsersFound {
      text-align: center;
      margin-top: 40px;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    /* Chat Section */
    #chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
      overflow: hidden;
    }

    #user-bar {
      width: 100%;
      background: var(--bg-secondary);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      transition: var(--transition);
    }

    #user-bar h2 {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #user-bar h2::before {
      content: 'üë§';
      font-size: 1.5rem;
    }

    #call-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 1.3rem;
      transition: var(--transition);
      box-shadow: var(--shadow-md);
    }

    #call-icon i {
      font-size: 1.1rem;
    }

    #call-icon:hover {
      transform: scale(1.1) rotate(15deg);
      box-shadow: var(--shadow-lg);
    }

    #call-icon:active {
      transform: scale(0.95);
    }

    /* Messages Area */
    #messages {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 24px;
      overflow-y: auto;
      gap: 16px;
      background: var(--bg-primary);
    }

    #messages::-webkit-scrollbar {
      width: 8px;
    }

    #messages::-webkit-scrollbar-track {
      background: transparent;
    }

    #messages::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
    }

    .message {
      padding: 16px 20px;
      border-radius: var(--border-radius);
      margin-bottom: 8px;
      font-size: 0.95rem;
      position: relative;
      max-width: 75%;
      word-wrap: break-word;
      animation: slideIn 0.3s ease-out;
      box-shadow: var(--shadow-sm);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .sent {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
      align-self: flex-end;
      color: #fff;
      border-bottom-right-radius: 4px;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .received {
      background: var(--bg-tertiary);
      backdrop-filter: blur(10px);
      align-self: flex-start;
      color: var(--text-primary);
      border-bottom-left-radius: 4px;
      border: 1px solid var(--border-color);
    }

    .message .username {
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 6px;
      opacity: 0.9;
    }

    .message .message-content {
      line-height: 1.5;
      margin-bottom: 8px;
    }

    .message .timestamp {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .message .status-badge {
      font-size: 0.7rem;
      opacity: 0.8;
      margin-top: 4px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    /* Input Container */
    #input-container {
      display: flex;
      gap: 12px;
      padding: 20px 24px;
      background: var(--bg-secondary);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--border-color);
    }

    #messageInput {
      flex: 1;
      padding: 16px 20px;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      backdrop-filter: blur(10px);
      font-size: 0.95rem;
      color: var(--text-primary);
      transition: var(--transition);
    }

    #messageInput:focus {
      outline: none;
      border-color: var(--accent-color);
      background: rgba(59, 130, 246, 0.1);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    #messageInput::placeholder {
      color: var(--text-muted);
    }

    #sendButton {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
      color: #fff;
      border: none;
      border-radius: var(--border-radius);
      padding: 16px 32px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: var(--transition);
      box-shadow: var(--shadow-md);
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 120px;
      justify-content: center;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    #sendButton:hover {
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent-color) 100%);
    }

    #sendButton i {
      font-size: 0.9rem;
    }

    #sendButton:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    #sendButton:active {
      transform: translateY(0);
    }

    #sendButton:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Floating Action Buttons */
    #toggleButton,
    #newChatButton,
    #callHistoryButton {
      position: fixed;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
      transition: var(--transition);
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
      color: white;
      z-index: 999;
      border: 2px solid rgba(59, 130, 246, 0.4);
    }

    #toggleButton:hover,
    #newChatButton:hover,
    #callHistoryButton:hover {
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent-color) 100%);
    }

    #toggleButton i,
    #newChatButton i,
    #callHistoryButton i {
      font-size: 1.2rem;
    }

    #toggleButton {
      bottom: 160px;
    }

    #newChatButton {
      bottom: 90px;
    }

    #callHistoryButton {
      bottom: 230px;
    }

    #toggleButton:hover,
    #newChatButton:hover,
    #callHistoryButton:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: var(--shadow-xl);
    }

    #toggleButton:active,
    #newChatButton:active,
    #callHistoryButton:active {
      transform: translateY(-2px) scale(1.02);
    }

    /* Modals */
    #newChatModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 32px;
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-xl);
      display: none;
      max-width: 420px;
      width: 90%;
      z-index: 10000;
      border: 1px solid var(--border-color);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translate(-50%, -60%);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }

    #newChatModal h3 {
      margin-bottom: 24px;
      font-weight: 700;
      font-size: 1.5rem;
      color: var(--text-primary);
      text-align: center;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border-color);
    }

    #newChatModal input[type="text"] {
      width: 100%;
      padding: 14px 18px;
      margin-bottom: 16px;
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: var(--transition);
    }

    #newChatModal input[type="text"]:focus {
      outline: none;
      border-color: var(--accent-color);
      background: rgba(59, 130, 246, 0.1);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    #newChatModal button {
      padding: 12px 24px;
      margin-right: 10px;
      border: none;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
      color: #fff;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    #newChatModal button i {
      font-size: 0.85rem;
    }

    #newChatModal button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    #newChatModal #userList {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--border-radius-sm);
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
    }

    #newChatModal #userList li {
      margin-bottom: 8px;
      padding: 12px;
      border-radius: var(--border-radius-sm);
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.05);
      transition: var(--transition);
      cursor: pointer;
      position: relative;
    }

    #newChatModal #userList li:hover {
      background: rgba(37, 99, 235, 0.2);
      transform: translateX(4px);
    }

    #newChatModal #userList li.selected {
      background: linear-gradient(135deg, rgba(138, 43, 226, 0.3), rgba(75, 0, 130, 0.3));
      border: 2px solid rgba(138, 43, 226, 0.6);
      box-shadow: 0 4px 15px rgba(138, 43, 226, 0.3);
    }

    #newChatModal #userList li.selected::after {
      content: '‚úì';
      position: absolute;
      right: 15px;
      color: #8a2be2;
      font-weight: bold;
      font-size: 18px;
    }

    /* Call Popups */
    #callerCallPopup,
    #incomingCallPopup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      color: var(--text-primary);
      padding: 32px;
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-xl);
      z-index: 10000;
      text-align: center;
      width: 320px;
      border: 1px solid var(--border-color);
      animation: modalSlideIn 0.3s ease-out;
    }

    #callerCallPopup h2,
    #incomingCallPopup h2 {
      margin-bottom: 16px;
      font-size: 1.5rem;
      font-weight: 600;
    }

    #callerCallPopup p,
    #incomingCallPopup p {
      margin-bottom: 24px;
      color: var(--text-secondary);
    }

    #callerCallPopup button,
    #incomingCallPopup button {
      border: none;
      border-radius: var(--border-radius-sm);
      padding: 12px 24px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      margin: 0 8px;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
    }

    #acceptCallButton {
      background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
      color: #fff;
    }

    #acceptCallButton:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    #declineCallButton,
    #callerCallPopup button {
      background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
      color: #fff;
    }

    #declineCallButton:hover,
    #callerCallPopup button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    /* In-Call Info */
    #inCallInfo {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 420px;
      max-width: 90vw;
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.98) 100%);
      backdrop-filter: blur(30px);
      color: var(--text-primary);
      padding: 40px 32px;
      border-radius: 24px;
      text-align: center;
      z-index: 10000;
      border: 1px solid rgba(138, 43, 226, 0.3);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(138, 43, 226, 0.2);
      animation: slideInCall 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes slideInCall {
      from {
        opacity: 0;
        transform: translate(-50%, -60%);
        scale: 0.9;
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%);
        scale: 1;
      }
    }

    #inCallInfo .call-header {
      margin-bottom: 32px;
    }

    #inCallInfo .call-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(138, 43, 226, 0.8), rgba(75, 0, 130, 0.8));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: 700;
      color: #fff;
      margin: 0 auto 16px;
      border: 4px solid rgba(138, 43, 226, 0.5);
      box-shadow: 0 8px 24px rgba(138, 43, 226, 0.4);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 8px 24px rgba(138, 43, 226, 0.4);
      }
      50% {
        box-shadow: 0 8px 32px rgba(138, 43, 226, 0.6);
      }
    }

    #inCallInfo .call-name {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: #fff;
    }

    #inCallInfo .call-timer {
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.7);
      font-weight: 500;
      letter-spacing: 1px;
    }

    #inCallInfo .call-controls {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 32px;
      flex-wrap: wrap;
    }

    #muteButton {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.9) 0%, rgba(37, 99, 235, 0.9) 100%);
      color: #fff;
      border: none;
      border-radius: 16px;
      padding: 16px 32px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 140px;
      justify-content: center;
    }

    #muteButton:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 24px rgba(59, 130, 246, 0.6);
      background: linear-gradient(135deg, rgba(59, 130, 246, 1) 0%, rgba(37, 99, 235, 1) 100%);
    }

    #muteButton:active {
      transform: translateY(-1px);
    }

    #muteButton.muted {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.9) 0%, rgba(220, 38, 38, 0.9) 100%);
      box-shadow: 0 4px 16px rgba(239, 68, 68, 0.4);
    }

    #muteButton.muted:hover {
      box-shadow: 0 6px 24px rgba(239, 68, 68, 0.6);
      background: linear-gradient(135deg, rgba(239, 68, 68, 1) 0%, rgba(220, 38, 38, 1) 100%);
    }

    #endCallButtonInCall {
      background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
      color: #fff;
      border: none;
      border-radius: 16px;
      padding: 16px 32px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 16px rgba(239, 68, 68, 0.4);
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 140px;
      justify-content: center;
    }

    #endCallButtonInCall:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 6px 24px rgba(239, 68, 68, 0.6);
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    #endCallButtonInCall:active {
      transform: translateY(-1px) scale(1.02);
    }

    #inCallInfo .call-status {
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 16px;
      font-weight: 400;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      margin: 5% auto;
      padding: 32px;
      border: 1px solid var(--border-color);
      width: 90%;
      max-width: 700px;
      border-radius: var(--border-radius-lg);
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
      animation: modalSlideIn 0.3s ease-out;
    }

    .modal-content h3 {
      color: var(--text-primary);
    }

    .modal-content h3 i {
      margin-right: 8px;
      font-size: 1.2rem;
      color: var(--accent-color);
    }

    .close {
      color: var(--text-muted);
      float: right;
      font-size: 32px;
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition);
      line-height: 1;
    }

    .close:hover {
      color: var(--text-primary);
      transform: rotate(90deg);
    }

    /* Call History */
    #callHistoryList {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }

    #callHistoryList li {
      padding: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      gap: 16px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: var(--border-radius-sm);
      margin-bottom: 8px;
      transition: var(--transition);
      cursor: pointer;
    }

    #callHistoryList li:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(4px);
    }

    .call-info {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }

    .call-info strong {
      font-size: 1rem;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .call-time,
    .call-status {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .call-status.missed-call {
      color: var(--danger-color);
    }

    .call-status.outgoing-call {
      color: var(--success-color);
    }

    .call-status.incoming-call {
      color: var(--accent-color);
    }

    .call-profile {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 1.2rem;
      font-weight: 600;
      flex-shrink: 0;
      box-shadow: var(--shadow-sm);
      border: 2px solid rgba(59, 130, 246, 0.4);
    }

    /* Connection Status */
    #connectionStatus {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
      color: white;
      text-align: center;
      padding: 12px;
      z-index: 10001;
      font-weight: 600;
      box-shadow: var(--shadow-md);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      #chat-container {
        flex-direction: column;
        height: calc(100vh - 80px);
        margin: 12px;
      }

      #conversations {
        width: 100%;
        max-height: 200px;
        border-right: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      #toggleButton,
      #newChatButton,
      #callHistoryButton {
        width: 48px;
        height: 48px;
        font-size: 1.1rem;
      }

      #toggleButton {
        bottom: 140px;
      }

      #newChatButton {
        bottom: 80px;
      }

      #callHistoryButton {
        bottom: 200px;
      }
    }

    /* Loading Animation */
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }

    .loading {
      background: linear-gradient(90deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 100%);
      background-size: 1000px 100%;
      animation: shimmer 2s infinite;
    }

    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      text-align: center;
      padding: 40px;
    }

    .empty-state::before {
      content: 'üí¨';
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 1.1rem;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <!-- Top Bar -->
  <div id="top-bar">
    <div class="brand">Real-Time Chat</div>
    <div class="controls">
      <span class="welcome">Welcome, <span id="username-display"></span>!</span>
      <button id="logoutButton" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
      </button>
    </div>
  </div>

  <!-- Main Container -->
  <div id="chat-container">
    <!-- Conversation List -->
    <div id="conversations">
      <h3>Conversations</h3>
      <input id="searchInput" type="text" placeholder="üîç Search users or groups...">
      <ul id="conversations-list">
        <li id="noUsersFound" style="display:none;" class="empty-state">
          <p>No conversations found</p>
        </li>
      </ul>
    </div>

    <!-- Chat Section -->
    <div id="chat">
      <div id="user-bar">
        <h2><span id="chatWith">No one</span></h2>
        <button id="call-icon" onclick="startCall()" title="Start Voice Call">
          <i class="fas fa-phone"></i>
        </button>
      </div>
      <div id="messages">
        <div class="empty-state">
          <p>Select a conversation to start chatting</p>
        </div>
      </div>
      <div id="input-container">
        <input id="messageInput" type="text" placeholder="Type your message here...">
        <button id="sendButton">
          <i class="fas fa-paper-plane"></i> Send
        </button>
      </div>
    </div>

    <!-- Call History Modal -->
    <div id="callHistoryModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h3><i class="fas fa-history"></i> Call History</h3>
        <ul id="callHistoryList"></ul>
      </div>
    </div>
  </div>

  <!-- New Chat Modal -->
  <div id="newChatModal">
    <h3><i class="fas fa-users"></i> Create a New Group</h3>
    <input type="text" id="groupName" placeholder="Enter group name" />
    <input type="text" id="searchUserInput" placeholder="üîç Search users..." oninput="searchUsers()" />
    <ul id="userList"></ul>
    <button id="createGroupButton" onclick="createGroup()">
      <i class="fas fa-plus"></i> Create
    </button>
    <button onclick="closeNewChatModal()">
      <i class="fas fa-times"></i> Close
    </button>
  </div>

  <!-- Connection Status -->
  <div id="connectionStatus">
    <i class="fas fa-exclamation-triangle"></i> Connection Issue! Check your network.
  </div>

  <!-- Floating Buttons -->
  <div id="toggleButton" onclick="toggleDarkMode()" title="Toggle Dark Mode">
    <i class="fas fa-moon"></i>
  </div>
  <div id="newChatButton" onclick="openNewChatModal()" title="New Chat">
    <i class="fas fa-plus"></i>
  </div>
  <button id="callHistoryButton" title="Call History">
    <i class="fas fa-phone"></i>
  </button>

  <!-- Caller Popup -->
  <div id="callerCallPopup">
    <h2 id="callerNameDisplay">Calling...</h2>
    <p id="callerStatusText">Ringing...</p>
    <button id="cancelCallerButton">
      <i class="fas fa-times"></i> Cancel
    </button>
  </div>

  <!-- Incoming Call Popup -->
  <div id="incomingCallPopup">
    <h2 id="incomingCallerName">Incoming call from ???</h2>
    <p>Ringing...</p>
    <div style="margin-top: 20px;">
      <button id="acceptCallButton">
        <i class="fas fa-phone"></i> Accept
      </button>
      <button id="declineCallButton">
        <i class="fas fa-times"></i> Decline
      </button>
    </div>
  </div>

  <!-- In-Call Info -->
  <div id="inCallInfo">
    <div class="call-header">
      <div class="call-avatar" id="callAvatar">U</div>
      <div class="call-name" id="inCallWithName">User</div>
      <div class="call-timer">
        <i class="fas fa-clock" style="margin-right: 6px;"></i>
        <span id="callTimer">00:00</span>
      </div>
    </div>
    <div class="call-controls">
      <button id="muteButton">
        <i class="fas fa-microphone"></i>
        <span>Mute</span>
      </button>
      <button id="endCallButtonInCall">
        <i class="fas fa-phone-slash"></i>
        <span>End Call</span>
      </button>
    </div>
    <div class="call-status">Connected</div>
  </div>

  <!-- Socket.io -->
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

  <!-- Main Script - Keep all existing JavaScript functionality -->
  <script>
    // All your existing JavaScript code here...
    // (Keeping the same functionality, just updating UI references)
    
    let selectedConversationId = null;
    let selectedConversationType = null;
    let localStream = null;
    let peerConnection = null;
    let receivedOffer = null;
    let callInterval = null;
    let callStartTime = 0;
    let currentCallUser = null;
    let isMuted = false;

    const token = localStorage.getItem('authToken');
    const username = localStorage.getItem('username');
    const socket = io('https://localhost:8443', { 
      secure: true,
      auth: {
        token: token
      },
      transports: ['websocket', 'polling']
    });

    if (!token) {
      alert('You need to login first.');
      window.location.href = '/login.html';
    }

    // Display username in top bar
    document.addEventListener("DOMContentLoaded", function () {
      if (username) {
        document.getElementById('username-display').textContent = username;
      }
    });

    // On Connect
    socket.on('connect', () => {
      socket.emit('setUsername', username);
    });

    socket.on('connect_error', (error) => {
      // Connection error handled silently
    });

    // Format time for call timer
    function formatTime(seconds) {
      const m = Math.floor(seconds / 60).toString().padStart(2,'0');
      const s = (seconds % 60).toString().padStart(2,'0');
      return m + ':' + s;
    }

    // Start call timer
    function startCallTimer() {
      callStartTime = Math.floor(Date.now() / 1000);
      callInterval = setInterval(() => {
        const now = Math.floor(Date.now() / 1000);
        const elapsed = now - callStartTime;
        document.getElementById('callTimer').textContent = formatTime(elapsed);
      }, 1000);
    }

    // Stop call timer
    function stopCallTimer() {
      clearInterval(callInterval);
      document.getElementById('callTimer').textContent = '00:00';
    }

    // Setup call history modal
    document.addEventListener("DOMContentLoaded", function () {
      loadConversations();
      loadCallHistory();

      const sendButton = document.getElementById('sendButton');
      sendButton.addEventListener('click', sendMessage);

      // Buttons
      const cancelCallButton = document.getElementById('cancelCallerButton');
      const acceptCallButton = document.getElementById('acceptCallButton');
      const declineCallButton = document.getElementById('declineCallButton');
      const endCallButtonInCall = document.getElementById('endCallButtonInCall');
      const callHistoryButton = document.getElementById('callHistoryButton');
      const modal = document.getElementById('callHistoryModal');
      const span = document.getElementsByClassName('close')[0];

      // Call History Modal Events
      callHistoryButton.onclick = function () {
        modal.style.display = 'block';
        loadCallHistory();
      };
      span.onclick = function () {
        modal.style.display = 'none';
      };
      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      };

      // Cancel call
      cancelCallButton.addEventListener('click', () => {
        if (currentCallUser) {
          socket.emit('callCancelled', { from: username, to: currentCallUser });
        }
        endCall();
      });

      // Accept call
      acceptCallButton.addEventListener('click', () => {
        if (!currentCallUser) return;
        socket.emit('callAccepted', { from: username, to: currentCallUser });

        document.getElementById('incomingCallPopup').style.display = 'none';

        if (receivedOffer) {
          if (!peerConnection) {
            peerConnection = new RTCPeerConnection(servers);
            setupPeerConnection();
          }

          peerConnection.setRemoteDescription(new RTCSessionDescription(receivedOffer))
            .then(() => {
              return navigator.mediaDevices.getUserMedia({ audio: true });
            })
            .then(stream => {
              localStream = stream;
              localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
              });
              return peerConnection.createAnswer();
            })
            .then(answer => {
              return peerConnection.setLocalDescription(answer);
            })
            .then(() => {
              socket.emit('answer', {
                to: currentCallUser,
                description: peerConnection.localDescription
              });
              document.getElementById('inCallWithName').textContent =
                document.getElementById('chatWith').textContent || '...';
              document.getElementById('inCallInfo').style.display = 'flex';
              startCallTimer();
            })
            .catch(error => {
              // Error handling offer
            });
        }
      });

      // End call
      endCallButtonInCall.addEventListener('click', () => {
        if (currentCallUser) {
          socket.emit('callEnded', { from: username, to: currentCallUser });
        }
        endCall();
      });

      // Setup search
      setupSearch();

      // Mute button
      const muteButton = document.getElementById('muteButton');
      muteButton.addEventListener('click', () => {
        if (localStream) {
          localStream.getAudioTracks().forEach(track => {
            track.enabled = !track.enabled;
          });
          isMuted = !isMuted;
          const muteIcon = muteButton.querySelector('i');
          const muteText = muteButton.querySelector('span');
          
          if (isMuted) {
            muteIcon.className = 'fas fa-microphone-slash';
            muteText.textContent = 'Unmute';
            muteButton.classList.add('muted');
          } else {
            muteIcon.className = 'fas fa-microphone';
            muteText.textContent = 'Mute';
            muteButton.classList.remove('muted');
          }
          socket.emit('muteStatus', { from: username, isMuted });
        }
      });
    });

    // Incoming call
    socket.on('incomingCall', ({ from }) => {
      currentCallUser = from;
      document.getElementById('incomingCallerName').textContent =
        'Incoming call from ' + from;
      document.getElementById('incomingCallPopup').style.display = 'block';

      const callTimer = setTimeout(() => {
        if (currentCallUser === from) {
          socket.emit('callMissed', { from, to: username });
          document.getElementById('incomingCallPopup').style.display = 'none';
          endCall();
        }
      }, 30000);

      socket.once('callAccepted', () => clearTimeout(callTimer));
      socket.once('callDeclined', () => clearTimeout(callTimer));
      socket.once('callCancelled', () => clearTimeout(callTimer));
    });

    // Call Missed
    socket.on('callMissed', ({ from, to }) => {
      if (username === from) {
        alert(`Your call to ${to} was not answered and has been ended.`);
        endCall();
      }
    });

    // Call Ended
    socket.on('callEnded', () => {
      endCall();
    });

    // Call Accepted
    socket.on('callAccepted', () => {
      let inCallWithName = document.getElementById('chatWith').textContent;
      if (inCallWithName === 'No one' || !inCallWithName) {
        inCallWithName = currentCallUser || 'Unknown User';
        document.getElementById('chatWith').textContent = inCallWithName;
      }
      document.getElementById('callerCallPopup').style.display = 'none';
      
      // Update call info
      const callNameElement = document.getElementById('inCallWithName');
      const callAvatarElement = document.getElementById('callAvatar');
      callNameElement.textContent = inCallWithName;
      callAvatarElement.textContent = inCallWithName.charAt(0).toUpperCase();
      
      document.getElementById('inCallInfo').style.display = 'flex';
      startCallTimer();
    });

    // Call Declined
    socket.on('callDeclined', ({ from, to }) => {
      if (username === to) {
        alert(`User ${from} declined your call.`);
        document.getElementById('callerCallPopup').style.display = 'none';
        endCall();
      }
    });

    // Call Cancelled
    socket.on('callCancelled', () => {
      document.getElementById('incomingCallPopup').style.display = 'none';
      document.getElementById('callerCallPopup').style.display = 'none';
      currentCallUser = null;
    });

    // New incoming message
    socket.on('newMessage', (message) => {
      if (message.conversationId === selectedConversationId) {
        const messagesDiv = document.getElementById('messages');
        if (message.from === username) return;
        const messageElement = createMessageElement(message, selectedConversationType);
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      } else {
        const conversationItems =
          document.querySelectorAll('#conversations-list li.conversation-item');
        conversationItems.forEach(item => {
          if (item.dataset.conversationId === message.conversationId) {
            item.classList.add('unread');
          }
        });
      }
    });

    // Status update
    socket.on('statusUpdate', (updatedMessages) => {
      if (updatedMessages && updatedMessages.length > 0 && selectedConversationId) {
        const messagesDiv = document.getElementById('messages');
        const currentScroll = messagesDiv.scrollTop;
        const wasAtBottom = messagesDiv.scrollHeight - messagesDiv.scrollTop <= messagesDiv.clientHeight + 100;
        const currentUsername = localStorage.getItem('username');
        
        updatedMessages.forEach(msg => {
          // Only update status for messages in the current conversation
          const msgConvId = msg.conversationId ? (msg.conversationId._id || msg.conversationId).toString() : null;
          const selectedConvId = selectedConversationId ? selectedConversationId.toString() : null;
          
          if (msgConvId === selectedConvId) {
            // Try multiple ways to find the message element
            const messageId = msg._id ? (msg._id._id || msg._id).toString() : null;
            let existingMessage = null;
            
            if (messageId) {
              existingMessage = messagesDiv.querySelector(`[data-message-id="${messageId}"]`);
            }
            
            if (existingMessage) {
              const statusBadge = existingMessage.querySelector('.status-badge');
              if (statusBadge) {
                // Only show status for sent messages
                if (msg.from === currentUsername) {
                  if (selectedConversationType === 'private') {
                    statusBadge.textContent = msg.status === 'seen' ? '‚úì‚úì Seen' : '‚úì Delivered';
                  } else {
                    if (msg.seenBy && Array.isArray(msg.seenBy) && msg.seenBy.includes(currentUsername)) {
                      statusBadge.textContent = '‚úì‚úì Seen';
                    } else {
                      statusBadge.textContent = '‚úì Sent';
                    }
                  }
                } else {
                  statusBadge.textContent = ''; // No status for received messages
                }
              }
            } else {
              // If message not found, reload messages to get updated status
              if (selectedConversationId) {
                loadMessages(selectedConversationId);
              }
            }
          }
        });
        
        if (wasAtBottom) {
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        } else {
          messagesDiv.scrollTop = currentScroll;
        }
      }
    });

    // WebRTC handlers
    socket.on('offer', description => {
      receivedOffer = description;
    });

    socket.on('answer', description => {
      if (peerConnection) {
        peerConnection.setRemoteDescription(new RTCSessionDescription(description))
          .catch(err => {
            // Error setting remote description
          });
      }
    });

    socket.on('iceCandidate', candidate => {
      if (peerConnection) {
        peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
          .catch(error => {
            // Error adding ICE candidate
          });
      }
    });

    const servers = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
      ]
    };

    // Set up peer connection
    function setupPeerConnection() {
      peerConnection.onicecandidate = event => {
        if (event.candidate && currentCallUser) {
          socket.emit('iceCandidate', {
            to: currentCallUser,
            candidate: event.candidate
          });
        }
      };

      peerConnection.ontrack = event => {
        const [remoteStream] = event.streams;
        const audioElement = document.createElement('audio');
        audioElement.srcObject = remoteStream;
        audioElement.autoplay = true;
        document.body.appendChild(audioElement);
      };

      peerConnection.oniceconnectionstatechange = () => {
        if (
          peerConnection.iceConnectionState === 'disconnected' ||
          peerConnection.iceConnectionState === 'failed' ||
          peerConnection.iceConnectionState === 'closed'
        ) {
          alert('Connection lost! Ending call.');
          endCall();
        }
      };
    }

    // Start call
    function startCall() {
      const calleeUsername = document.getElementById('chatWith').textContent;
      if (calleeUsername === 'No one') {
        alert('No user selected to call.');
        return;
      }
      currentCallUser = calleeUsername;

      document.getElementById('callerCallPopup').style.display = 'block';
      document.getElementById('callerNameDisplay').textContent =
        'Calling ' + calleeUsername;
      document.getElementById('callerStatusText').textContent = 'Ringing...';

      socket.emit('callInitiated', { from: username, to: calleeUsername });

      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          localStream = stream;
          peerConnection = new RTCPeerConnection(servers);
          setupPeerConnection();

          localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
          });

          return peerConnection.createOffer();
        })
        .then(offer => {
          return peerConnection.setLocalDescription(offer);
        })
        .then(() => {
          if (currentCallUser) {
            socket.emit('offer', {
              to: currentCallUser,
              description: peerConnection.localDescription
            });
          }
        })
        .catch(error => {
          document.getElementById('callerCallPopup').style.display = 'none';
        });
    }

    // End call
    function endCall() {
      if (peerConnection) {
        peerConnection.oniceconnectionstatechange = null;
        peerConnection.onconnectionstatechange = null;
        peerConnection.close();
        peerConnection = null;
      }
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }

      const audios = document.querySelectorAll('audio');
      audios.forEach(a => {
        if (a.srcObject && a !== document.querySelector('#localAudio')) {
          a.srcObject = null;
          a.remove();
        }
      });

      document.getElementById('callerCallPopup').style.display = 'none';
      document.getElementById('incomingCallPopup').style.display = 'none';
      document.getElementById('inCallInfo').style.display = 'none';

      stopCallTimer();
      currentCallUser = null;
      receivedOffer = null;
    }

    // Call history updated
    socket.on('callHistoryUpdated', () => {
      loadCallHistory();
    });

    // Load call history
    function loadCallHistory() {
      const token = localStorage.getItem('authToken');
      const currentUser = localStorage.getItem('username');
      fetch('https://localhost:8443/api/auth/call-history', {
        headers: { 'Authorization': 'Bearer ' + token }
      })
        .then(response => response.json())
        .then(data => {
          const callHistoryList = document.getElementById('callHistoryList');
          callHistoryList.innerHTML = '';
          if (!data.callHistory) return;

          data.callHistory.forEach(call => {
            const callItem = document.createElement('li');
            const callStatusClass = call.status === 'missed'
              ? 'missed-call'
              : (call.caller === currentUser
                ? 'outgoing-call'
                : 'incoming-call');

            let contactName, profileInitial;
            if (call.caller === currentUser) {
              contactName = call.receiver;
              profileInitial = call.receiver.charAt(0).toUpperCase();
            } else {
              contactName = call.caller;
              profileInitial = call.caller.charAt(0).toUpperCase();
            }

            const profileIcon = `<div class="call-profile">${profileInitial}</div>`;
            callItem.innerHTML = `
              ${profileIcon}
              <div class="call-info">
                <strong>${contactName}</strong>
                <div class="call-time">
                  ${new Date(call.startTime).toLocaleString()}
                </div>
                <div class="call-status ${callStatusClass}">
                  ${call.status}
                </div>
              </div>
            `;
            callHistoryList.appendChild(callItem);
          });
        })
        .catch(error => {
          // Error fetching call history
        });
    }

    // Load conversations
    function loadConversations() {
      const token = localStorage.getItem('authToken');
      fetch('https://localhost:8443/api/auth/users/conversations', {
        headers: { 'Authorization': 'Bearer ' + token }
      })
        .then(response => response.json())
        .then(data => {
          const conversationsList = document.getElementById('conversations-list');
          conversationsList.innerHTML = '';

          if (data.conversations && data.conversations.length > 0) {
            data.conversations.forEach(conversation => {
              const listItem = document.createElement('li');
              listItem.classList.add('conversation-item');
              listItem.dataset.conversationId = conversation._id || conversation.conversationId;

              let label = '';
              let otherUser = null;

              if (conversation.type === 'group') {
                label = conversation.name || 'Unnamed Group';
                listItem.addEventListener('click', () =>
                  startConversationWithGroup(
                    conversation._id || conversation.conversationId,
                    conversation.name
                  )
                );
              } else {
                otherUser = conversation.username || conversation.participants.find(p => p !== username);
                label = otherUser;
                listItem.addEventListener('click', () => startConversation(otherUser));
              }

              listItem.textContent = label;

              const avatarDiv = document.createElement('div');
              avatarDiv.classList.add('avatar');
              if (conversation.type === 'group') {
                avatarDiv.textContent = conversation.name
                  ? conversation.name.charAt(0).toUpperCase()
                  : 'G';
              } else {
                avatarDiv.textContent = otherUser
                  ? otherUser.charAt(0).toUpperCase()
                  : 'U';
              }
              listItem.insertBefore(avatarDiv, listItem.firstChild);
              conversationsList.appendChild(listItem);
            });
          } else {
            const noUsersFound = document.createElement('li');
            noUsersFound.id = 'noUsersFound';
            noUsersFound.textContent = 'No Conversations Found';
            noUsersFound.style.display = 'block';
            conversationsList.appendChild(noUsersFound);
          }
        })
        .catch(error => {
          // Error fetching conversations
        });
    }

    // Start conversation (private)
    function startConversation(selectedUser) {
      const token = localStorage.getItem('authToken');
      const from = localStorage.getItem('username');

      if (!from || !selectedUser) {
        alert("Please refresh and select a conversation.");
        return;
      }

      fetch('https://localhost:8443/api/auth/users/conversation', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ username: selectedUser })
      })
        .then(response => response.json())
        .then(data => {
          if (data.conversationId) {
            selectedConversationId = data.conversationId;
            selectedConversationType = 'private';
            document.getElementById('chatWith').textContent = selectedUser;

            const conversationItems = document.querySelectorAll(
              '#conversations-list li.conversation-item'
            );
            conversationItems.forEach(item => {
              item.classList.remove('active');
              if (item.dataset.conversationId === selectedConversationId) {
                item.classList.add('active');
                item.classList.remove('unread');
              }
            });

            socket.emit('joinConversation', selectedConversationId);
            // Wait a bit for status update, then load messages
            setTimeout(() => {
              loadMessages(selectedConversationId);
            }, 100);
          }
        })
        .catch(error => {
          alert('Error starting the conversation. Please try again.');
        });
    }

    // Load messages
    function loadMessages(conversationId) {
      const token = localStorage.getItem('authToken');
      fetch('https://localhost:8443/api/auth/conversations/' + conversationId + '/messages', {
        headers: { 'Authorization': 'Bearer ' + token }
      })
        .then(response => response.json())
        .then(data => {
          const messagesDiv = document.getElementById('messages');
          messagesDiv.innerHTML = '';
          if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => {
              messagesDiv.appendChild(renderMessage(msg));
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Request status update after loading to ensure latest status
            // This ensures all messages are marked as seen when conversation is opened
            if (conversationId) {
              socket.emit('joinConversation', conversationId);
            }
          } else {
            messagesDiv.innerHTML = '<div class="empty-state"><p>No messages yet. Start the conversation!</p></div>';
          }
        })
        .catch(error => {
          // Error loading messages
        });
    }

    // Render message
    function renderMessage(msg) {
      return createMessageElement(msg, selectedConversationType);
    }

    // Create message element
    function createMessageElement(msg, conversationType) {
      const messageElement = document.createElement('div');
      messageElement.className = msg.from === localStorage.getItem('username')
        ? 'message sent'
        : 'message received';
      messageElement.dataset.messageId = msg._id;

      if (conversationType === 'group') {
        const usernameElement = document.createElement('span');
        usernameElement.className = 'username';
        usernameElement.textContent = msg.from;
        messageElement.appendChild(usernameElement);
      }

      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      messageContent.textContent = msg.content;
      messageElement.appendChild(messageContent);

      const timestampElement = document.createElement('div');
      timestampElement.className = 'timestamp';
      const date = new Date(msg.timestamp);
      timestampElement.textContent = date.toLocaleString('en-US', {
        hour: '2-digit',
        minute: '2-digit'
      });
      messageElement.appendChild(timestampElement);

      const statusElement = document.createElement('div');
      statusElement.className = 'status-badge';

      const currentUsername = localStorage.getItem('username');
      if (conversationType === 'private') {
        // For sent messages, show status based on msg.status
        // For received messages, don't show status
        if (msg.from === currentUsername) {
          statusElement.textContent =
            msg.status === 'seen' ? '‚úì‚úì Seen' : '‚úì Delivered';
        } else {
          statusElement.textContent = ''; // No status for received messages
        }
      } else {
        // For group messages
        if (msg.from === currentUsername) {
          if (msg.seenBy && msg.seenBy.includes(currentUsername)) {
            statusElement.textContent = '‚úì‚úì Seen';
          } else {
            statusElement.textContent = '‚úì Sent';
          }
        } else {
          statusElement.textContent = ''; // No status for received messages
        }
      }
      messageElement.appendChild(statusElement);

      return messageElement;
    }

    // Start group conversation
    function startConversationWithGroup(groupId, groupName) {
      selectedConversationId = groupId;
      selectedConversationType = 'group';

      if (!groupId) {
        alert("Group ID is missing.");
        return;
      }

      const conversationItems = document.querySelectorAll(
        '#conversations-list li.conversation-item'
      );
      conversationItems.forEach(item => {
        item.classList.remove('active');
        if (item.dataset.conversationId === selectedConversationId) {
          item.classList.add('active');
          item.classList.remove('unread');
        }
      });

      socket.emit('joinConversation', groupId);
      
      // Wait a bit for status update, then load messages
      setTimeout(() => {
        document.getElementById('chatWith').textContent = groupName || 'Unnamed Group';
        loadGroupMessages(groupId);
      }, 100);
    }

    // Load group messages
    function loadGroupMessages(groupId) {
      const token = localStorage.getItem('authToken');
      fetch('https://localhost:8443/api/auth/groups/' + groupId + '/messages', {
        headers: { 'Authorization': 'Bearer ' + token }
      })
        .then(response => response.json())
        .then(data => {
          const messagesDiv = document.getElementById('messages');
          messagesDiv.innerHTML = '';
          if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => {
              const messageElement = renderMessage(msg);
              messagesDiv.appendChild(messageElement);
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Request status update after loading to ensure latest status
            if (groupId) {
              socket.emit('joinConversation', groupId);
            }
          } else {
            messagesDiv.innerHTML = '<div class="empty-state"><p>No messages yet. Start the conversation!</p></div>';
          }
        })
        .catch(error => {
          alert('Error loading group messages.');
        });
    }

    // Logout
    function logout() {
      localStorage.removeItem('authToken');
      localStorage.removeItem('username');
      window.location.href = '/login.html';
    }

    // Setup search
    function setupSearch() {
      const searchInput = document.getElementById('searchInput');
      const token = localStorage.getItem('authToken');

      searchInput.addEventListener('input', function () {
        const searchTerm = searchInput.value.trim();
        if (searchTerm.length > 0) {
          fetch('https://localhost:8443/api/auth/users/search?username=' + searchTerm, {
            headers: {
              'Authorization': 'Bearer ' + token
            }
          })
            .then(response => response.json())
            .then(data => {
              const conversationsList = document.getElementById('conversations-list');
              conversationsList.innerHTML = '';

              const conversationIds = new Set();

              if (
                (data.users && data.users.length > 0) ||
                (data.groups && data.groups.length > 0)
              ) {
                if (data.users && data.users.length > 0) {
                  data.users.forEach(user => {
                    if (conversationIds.has(user._id)) return;
                    conversationIds.add(user._id);
                    const conversationItem = document.createElement('li');
                    conversationItem.textContent = user.username || 'Unnamed User';
                    conversationItem.classList.add('conversation-item');
                    conversationItem.addEventListener('click', () =>
                      startConversation(user.username)
                    );
                    conversationsList.appendChild(conversationItem);
                  });
                }
                if (data.groups && data.groups.length > 0) {
                  data.groups.forEach(group => {
                    if (conversationIds.has(group._id)) return;
                    conversationIds.add(group._id);
                    const conversationItem = document.createElement('li');
                    conversationItem.textContent = group.name
                      ? 'Group: ' + group.name
                      : 'Unnamed Group';
                    conversationItem.classList.add('conversation-item');
                    conversationItem.addEventListener('click', () =>
                      startConversationWithGroup(group._id, group.name)
                    );
                    conversationsList.appendChild(conversationItem);
                  });
                }
              } else {
                const noUsersFound = document.createElement('li');
                noUsersFound.textContent = 'No users or groups found';
                conversationsList.appendChild(noUsersFound);
              }
            })
            .catch(error => {
              // Error searching for users/groups
            });
        } else {
          loadConversations();
        }
      });
    }

    // Group creation
    let selectedUsers = new Set();
    function openNewChatModal() {
      document.getElementById('newChatModal').style.display = 'block';
      document.getElementById('userList').innerHTML = '';
      loadUsersForGroup();
    }
    function closeNewChatModal() {
      document.getElementById('newChatModal').style.display = 'none';
      selectedUsers.clear();
    }
    function loadUsersForGroup() {
      const token = localStorage.getItem('authToken');
      fetch('https://localhost:8443/api/auth/users', {
        headers: { 'Authorization': 'Bearer ' + token }
      })
        .then(response => response.json())
        .then(data => {
          const userList = document.getElementById('userList');
          userList.innerHTML = '';
          if (data.users && Array.isArray(data.users)) {
            data.users.forEach(user => {
              if (user.username !== localStorage.getItem('username')) {
                const listItem = document.createElement('li');
                listItem.textContent = user.username;
                listItem.dataset.username = user.username;
                
                if (selectedUsers.has(user.username)) {
                  listItem.classList.add('selected');
                }

                listItem.addEventListener('click', function() {
                  if (selectedUsers.has(user.username)) {
                    selectedUsers.delete(user.username);
                    listItem.classList.remove('selected');
                  } else {
                    selectedUsers.add(user.username);
                    listItem.classList.add('selected');
                  }
                });
                
                userList.appendChild(listItem);
              }
            });
          } else {
            userList.innerHTML = '<li>No users found</li>';
          }
        })
        .catch(error => {
          // Error loading users
        });
    }
    function searchUsers() {
      const searchTerm = document.getElementById('searchUserInput').value.trim();
      const token = localStorage.getItem('authToken');
      const currentUser = localStorage.getItem('username');
      if (searchTerm === '') {
        loadUsersForGroup();
        return;
      }
      fetch('https://localhost:8443/api/auth/users/search?username=' + searchTerm, {
        headers: { 'Authorization': 'Bearer ' + token }
      })
        .then(response => response.json())
        .then(data => {
          const userList = document.getElementById('userList');
          userList.innerHTML = '';
          if (data.users && data.users.length > 0 && searchTerm.toLowerCase() !== currentUser.toLowerCase()) {
            data.users.forEach(user => {
              if (user.username !== currentUser) {
                const listItem = document.createElement('li');
                listItem.textContent = user.username;
                listItem.dataset.username = user.username;
                
                if (selectedUsers.has(user.username)) {
                  listItem.classList.add('selected');
                }

                listItem.addEventListener('click', function() {
                  if (selectedUsers.has(user.username)) {
                    selectedUsers.delete(user.username);
                    listItem.classList.remove('selected');
                  } else {
                    selectedUsers.add(user.username);
                    listItem.classList.add('selected');
                  }
                });
                
                userList.appendChild(listItem);
              }
            });
          } else {
            userList.innerHTML = '<li>No users found</li>';
          }
        })
        .catch(error => {
          // Error searching for users
        });
    }
    function createGroup() {
      if (selectedUsers.size < 2) {
        alert('Select at least two users for a group.');
        return;
      }
      const groupName = document.getElementById('groupName').value.trim();
      if (!groupName) {
        alert('Enter a group name.');
        return;
      }
      const token = localStorage.getItem('authToken');
      const currentUser = localStorage.getItem('username');
      fetch('https://localhost:8443/api/auth/groups', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({
          groupName,
          members: [currentUser, ...Array.from(selectedUsers)]
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.groupId) {
            alert('Group created successfully.');
            closeNewChatModal();
            loadConversations();
          } else {
            alert('Failed to create group.');
          }
        })
        .catch(error => {
          // Error creating group
        });
    }

    // Dark Mode
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const toggleButton = document.getElementById('toggleButton');
      const icon = toggleButton.querySelector('i');
      if (document.body.classList.contains('dark-mode')) {
        icon.className = 'fas fa-sun';
        toggleButton.title = 'Light Mode';
      } else {
        icon.className = 'fas fa-moon';
        toggleButton.title = 'Dark Mode';
      }
    }

    // Connection Status
    function updateConnectionStatus() {
      const connectionStatusDiv = document.getElementById('connectionStatus');
      if (!navigator.onLine) {
        connectionStatusDiv.style.display = 'block';
      } else {
        connectionStatusDiv.style.display = 'none';
      }
    }
    document.addEventListener("DOMContentLoaded", function () {
      updateConnectionStatus();
      window.addEventListener('online', updateConnectionStatus);
      window.addEventListener('offline', updateConnectionStatus);
    });

    // Send message
    function sendMessage() {
      const content = document.getElementById('messageInput').value.trim();
      const conversationId = selectedConversationId;
      if (!conversationId) {
        alert("No conversation selected.");
        return;
      }
      if (!content) {
        alert("Message cannot be empty.");
        return;
      }
      const from = localStorage.getItem('username');
      const timestamp = new Date().toISOString();
      const data = { conversationId, from, content, timestamp };
      socket.emit('message', data);

      document.getElementById('messageInput').value = '';
      const messagesDiv = document.getElementById('messages');
      
      // Remove empty state if exists
      const emptyState = messagesDiv.querySelector('.empty-state');
      if (emptyState) {
        emptyState.remove();
      }
      
      const messageElement = createMessageElement({
        from: from,
        content: content,
        timestamp: timestamp,
        status: 'delivered'
      }, selectedConversationType);
      messageElement.className = 'message sent';
      messagesDiv.appendChild(messageElement);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Enter key to send
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
  </script>
</body>
</html>
